# Wazuh UniFi Decoder and Rules ConfigMap
# Custom decoders and rules for UniFi device logs
# These files will be copied to /var/ossec/etc/decoders/ and /var/ossec/etc/rules/
# by the initContainer, where Wazuh will auto-load them
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-unifi-decoder-config
  namespace: managed-tools
  labels:
    app: wazuh
    component: server
    managed-by: gitops
data:
  # Custom decoder file (will be copied to /var/ossec/etc/decoders/custom/)
  unifi_decoders.xml: |
    <!-- UniFi Decoders for Wazuh -->
    <!-- Based on Reddit discussion and Wazuh documentation -->
    <!-- UniFi logs come in various formats - we need flexible decoders -->
    
    <!-- Primary decoder: Matches UniFi messages with standard syslog format -->
    <!-- Matches messages containing "unifi" (case-insensitive) in hostname or message -->
    <decoder name="unifi">
      <prematch>unifi</prematch>
      <type>syslog</type>
    </decoder>

    <!-- Alternative: Match "Ubiquiti" or "UniFi Network" in message -->
    <decoder name="unifi-ubiquiti">
      <prematch>Ubiquiti|UniFi Network</prematch>
      <type>syslog</type>
    </decoder>

    <!-- Decoder for UniFi messages with structured format -->
    <!-- Format: |version|type|information|severity|UNIFIcategory=... UNIFIsubCategory=... -->
    <decoder name="unifi-structured">
      <parent>unifi</parent>
      <regex offset="after_prematch">\|(\S+)\|(\d+)\|(.+?)\|(\d+)\|UNIFIcategory=(\S+)</regex>
      <order>version,type,information,severity,UNIFIcategory</order>
    </decoder>

    <!-- Enhanced structured decoder with more fields -->
    <decoder name="unifi-custom">
      <parent>unifi-structured</parent>
      <regex>UNIFIsubCategory=(\S+)\s+UNIFIhost=(\S+)\s+UNIFIsite=(\S+)</regex>
      <order>UNIFIsubCategory,UNIFIhost,UNIFIsite</order>
    </decoder>

    <!-- Decoder for standard syslog format with unifi hostname -->
    <!-- Format: timestamp hostname message (where hostname contains "unifi") -->
    <decoder name="unifi-syslog">
      <parent>unifi</parent>
      <regex offset="after_prematch">(\S+):\s+(.+)$</regex>
      <order>hostname_suffix,message</order>
    </decoder>

    <!-- Fallback decoder: Catch any message with "unifi" that doesn't match above patterns -->
    <!-- This ensures all UniFi messages are at least detected, even if not fully parsed -->
    <decoder name="unifi-fallback">
      <parent>unifi</parent>
      <regex offset="after_prematch">(.+)$</regex>
      <order>message</order>
    </decoder>

  # Custom rules file (will be copied to /var/ossec/etc/rules/custom/)
  unifi_rules.xml: |
    <!-- UniFi Rules for Wazuh -->
    <!-- Based on Reddit discussion - flexible rules to catch all UniFi events -->
    <!-- Rule group for UniFi events -->
    <group name="unifi,">
      <!-- Base rule: Catch all UniFi messages (low level) -->
      <!-- This ensures all UniFi messages appear in logs, even if they don't match specific patterns -->
      <rule id="100001" level="3">
        <decoded_as>unifi</decoded_as>
        <description>UniFi event detected: $message</description>
      </rule>

      <!-- Rule for Ubiquiti/UniFi Network branded messages -->
      <rule id="100000" level="3">
        <decoded_as>unifi-ubiquiti</decoded_as>
        <description>UniFi/Ubiquiti event: $message</description>
      </rule>

      <!-- Structured format messages -->
      <rule id="100002" level="5">
        <decoded_as>unifi-structured</decoded_as>
        <if_sid>100001</if_sid>
        <description>UniFi structured event: type=$type, severity=$severity, category=$UNIFIcategory</description>
      </rule>

      <!-- Authentication events -->
      <rule id="100003" level="5">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100002</if_sid>
        <match>auth</match>
        <description>UniFi authentication event: $UNIFIsubCategory from $UNIFIhost at $UNIFIsite</description>
      </rule>

      <!-- Security events -->
      <rule id="100004" level="10">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100002</if_sid>
        <match>security</match>
        <description>UniFi security event: $UNIFIsubCategory on $UNIFIhost at $UNIFIsite</description>
      </rule>

      <!-- High-severity security alerts -->
      <rule id="100005" level="12">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100004</if_sid>
        <match>failed|denied|blocked|intrusion|attack</match>
        <description>UniFi security alert: $UNIFIsubCategory on $UNIFIhost - $message</description>
      </rule>

      <!-- Wireless events -->
      <rule id="100006" level="5">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100002</if_sid>
        <match>wireless</match>
        <description>UniFi wireless event: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>

      <!-- System events -->
      <rule id="100007" level="4">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100002</if_sid>
        <match>system</match>
        <description>UniFi system event: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>

      <!-- Network events -->
      <rule id="100008" level="5">
        <decoded_as>unifi-custom</decoded_as>
        <if_sid>100002</if_sid>
        <match>network</match>
        <description>UniFi network event: $UNIFIsubCategory on $UNIFIhost</description>
      </rule>

      <!-- Fallback: Catch any UniFi message that doesn't match above patterns -->
      <!-- This ensures visibility of all UniFi messages -->
      <rule id="100009" level="3">
        <decoded_as>unifi-fallback</decoded_as>
        <if_sid>100001</if_sid>
        <description>UniFi message (unstructured): $message</description>
      </rule>
    </group>
  
  # Script to copy decoders and rules to appropriate directories
  copy-custom-files.sh: |
    #!/bin/bash
    set -e
    
    echo "Copying UniFi decoders and rules to Wazuh directories..."
    
    DECODER_DIR="/var/ossec/etc/decoders/custom"
    RULES_DIR="/var/ossec/etc/rules/custom"
    
    # Create directories if they don't exist
    mkdir -p "$DECODER_DIR" "$RULES_DIR"
    
    # Copy decoder file
    if [ -f "/tmp/unifi_decoders.xml" ]; then
      cp /tmp/unifi_decoders.xml "$DECODER_DIR/unifi_decoders.xml"
      chmod 640 "$DECODER_DIR/unifi_decoders.xml"
      chown root:wazuh "$DECODER_DIR/unifi_decoders.xml"
      echo "✅ Copied unifi_decoders.xml to $DECODER_DIR"
    else
      echo "⚠️  unifi_decoders.xml not found, skipping..."
    fi
    
    # Copy rules file
    if [ -f "/tmp/unifi_rules.xml" ]; then
      cp /tmp/unifi_rules.xml "$RULES_DIR/unifi_rules.xml"
      chmod 640 "$RULES_DIR/unifi_rules.xml"
      chown root:wazuh "$RULES_DIR/unifi_rules.xml"
      echo "✅ Copied unifi_rules.xml to $RULES_DIR"
    else
      echo "⚠️  unifi_rules.xml not found, skipping..."
    fi
    
    echo "Custom decoders and rules deployed successfully!"
